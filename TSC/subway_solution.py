import pandas as pd
import os as os
import numpy as np

df = pd.read_csv('./data/subway-data.csv', encoding="cp949")

valid_lines = [f"{i}호선" for i in range(1, 10)]
df = df[df['호선명'].isin(valid_lines)].copy()



# 문제 1 (데이터 기본 확인) df의 행/열 개수와 컬럼 개수를 출력하시오.

print('=' * 100)
print("문제 1")
print('=' * 100)

print(df.shape)
print(len(df.columns))



# 문제 2 전체 데이터에서 값이 0인 데이터가 총 몇 개인지 구하시오.
# 힌트: .sum().sum() → 열 → 전체 합

zero_count = (df == 0).sum().sum()

print('=' * 100)
print("문제 2")
print('=' * 100)

print(zero_count)



# 문제 3 (호선 데이터 균형 확인)
# 가장 많은 행을 가진 호선과
# 가장 적은 행을 가진 호선의 행 개수 차이를 출력하시오.

counts = df['호선명'].value_counts()

max_count = counts.max()
min_count = counts.min()

print('=' * 100)
print("문제 3")
print('=' * 100)

print(max_count - min_count)



# 문제 4 데이터에 등장하는 지하철역 이름의 종류 개수를 구하시오.

stations = df['지하철역'].value_counts()

print('=' * 100)
print("문제 4")
print('=' * 100)

print(len(stations))



# 문제 5 (특정 역 데이터만 필터링)
# 지하철역이 "동대문" 인 데이터만 따로 뽑아 dongdaemun_df를 만들고, 상위 3행을 출력하시오.

dongdaemun_df = df[df['지하철역'] == '동대문']

print('=' * 100)
print("문제 5")
print('=' * 100)

print(dongdaemun_df.head(3))



# 문제 6 (특정 월 데이터만 필터링)
# 사용월이 202511 인 데이터만 뽑아 df_202511을 만들고, 행 개수를 출력하시오.

df_202511 = df[df['사용월'] == 202511]

print('=' * 100)
print("문제 6")
print('=' * 100)

print(len(df_202511))



# 문제 7 모든 시간대의 승차인원만 합산한 총승차인원 컬럼을 생성하시오.

ride_cols = [c for c in df.columns if '승차인원' in c]
df['총승차인원'] = df[ride_cols].sum(axis=1)



# 문제 8 모든 시간대의 하차인원만 합산한 총하차인원 컬럼을 생성하시오.

alight_cols = [c for c in df.columns if '하차인원' in c]
df['총하차인원'] = df[alight_cols].sum(axis=1)



# 문제 9 총승차인원 + 총하차인원으로 총 승하차 인원 컬럼을 생성하시오.

df['총승하차인원'] = df['총승차인원'] + df['총하차인원']



# 문제 10 총 승하차 인원이 가장 많은 상위 5개 역을 출력하시오.

result10 = df.sort_values('총승하차인원')[['호선명','지하철역','총승하차인원']].tail(5)

print('=' * 100)
print("문제 10")
print('=' * 100)

print(result10)



# 문제 11 출근 시간대(07시–09시)의 승차인원 합 컬럼을 생성하시오.

df['출근승차'] = (
    df['07시-08시 승차인원'] +
    df['08시-09시 승차인원']
)



# 문제 12 퇴근 시간대(17시–19시)의 하차인원 합 컬럼을 생성하시오.

df['퇴근하차'] = (
    df['17시-18시 하차인원'] +
    df['18시-19시 하차인원']
)



# 문제 13 출근 시간대 기준으로 승차인원 > 하차인원 인 역의 개수를 구하시오.

df['출근하차'] = (
    df['07시-08시 하차인원'] +
    df['08시-09시 하차인원']
)

print('=' * 100)
print("문제 13")
print('=' * 100)

print((df['출근승차'] > df['출근하차']).sum())



# 문제 14 출근 시간대에 승차 인원이 가장 많은 역 3개를 출력하시오.

result14 = df.sort_values('출근승차')[['호선명','지하철역','출근승차']].tail(3)

print('=' * 100)
print("문제 14")
print('=' * 100)

print(result14)



# 문제 15 퇴근 시간대에 하차 인원이 가장 많은 역 3개를 출력하시오.

result15 = df.sort_values('퇴근하차')[['호선명','지하철역','퇴근하차']].tail(3)

print('=' * 100)
print("문제 15")
print('=' * 100)

print(result15)



# 문제 16 (수정) 오전우세 컬럼 만들기
# 오전우세는 "오전 유동 - 오후 유동" 이다.
# 유동은 (승차 + 하차) 합으로 계산한다.
# 
# 오전_유동 = (07-08 유동) + (08-09 유동) + (09-10 유동) / 7시~10시만
# 오후_유동 = (17-18 유동) + (18-19 유동) + (19-20 유동) / 17시~20시만
#
# 오전우세 = 오전_유동 - 오후_유동

df['07-08_유동'] = df['07시-08시 승차인원'] + df['07시-08시 하차인원']
df['08-09_유동'] = df['08시-09시 승차인원'] + df['08시-09시 하차인원']
df['09-10_유동'] = df['09시-10시 승차인원'] + df['09시-10시 하차인원']

df['17-18_유동'] = df['17시-18시 승차인원'] + df['17시-18시 하차인원']
df['18-19_유동'] = df['18시-19시 승차인원'] + df['18시-19시 하차인원']
df['19-20_유동'] = df['19시-20시 승차인원'] + df['19시-20시 하차인원']

df['오전_유동'] = df['07-08_유동'] + df['08-09_유동'] + df['09-10_유동']
df['오후_유동'] = df['17-18_유동'] + df['18-19_유동'] + df['19-20_유동']

df['오전우세'] = df['오전_유동'] - df['오후_유동']



# 문제 17 오전우세가 큰 역 TOP 5를 출력하시오.

top5_morning = df.sort_values('오전우세')[['호선명','지하철역','오전우세']].tail(5)

print('=' * 100)
print("문제 17")
print('=' * 100)

print(top5_morning)



# 문제 18 오전/오후 성향 컬럼 만들기 
# 기준:
# 오전우세 > 0  → 오전형  (오전 유동이 오후 유동보다 큼)
# 오전우세 < 0  → 오후형  (오후 유동이 오전 유동보다 큼)
# 오전우세 == 0 → 혼합형  (오전과 오후가 동일)
#

df['시간성향'] = '혼합형'
df.loc[df['오전우세'] > 0, '시간성향'] = '오전형'
df.loc[df['오전우세'] < 0, '시간성향'] = '오후형'



# 문제 19 시간성향(오전형/오후형/혼합형) 별로 개수를 구해서 출력하시오.
# (힌트: 조건으로 각각 카운트, sum() 사용)

morning_cnt = (df['시간성향'] == '오전형').sum()
evening_cnt = (df['시간성향'] == '오후형').sum()
mixed_cnt = (df['시간성향'] == '혼합형').sum()

print('=' * 100)
print("문제 19")
print('=' * 100)

print("오전형:", morning_cnt)
print("오후형:", evening_cnt)
print("혼합형:", mixed_cnt)



# 문제 20 출근승차 / 출근하차 기준으로 역 성격 컬럼을 생성하시오.
#
# 기준 설명:
# - 출근승차 > 출근하차  → 주거지역
#   (아침에 사람들이 '그 역에서 많이 탄다' = 집에서 나오는 사람이 많다)
#
# - 출근하차 > 출근승차  → 업무지역
#   (아침에 사람들이 '그 역에서 많이 내린다' = 회사/학교로 유입이 많다)
#
# - 출근승차 == 출근하차 → 혼합지역
#   (아침에 타고 내리는 흐름이 비슷하다)

df.loc[df['출근승차'] > df['출근하차'], '역성격'] = '주거지역'
df.loc[df['출근하차'] > df['출근승차'], '역성격'] = '업무지역'
df.loc[df['출근승차'] == df['출근하차'], '역성격'] = '혼합지역'

print('=' * 100)
print("문제 20")
print('=' * 100)

print(df[['호선명','지하철역','역성격']].head())



# ================================
# 최종 보스 21~23
# ================================

# 문제 21 🔥 호선별로 "총승하차인원" 1등 역만 모은 데이터프레임 top_by_line을 만드시오.
# 출력 컬럼: ['호선명','지하철역','총승하차인원']
# (힌트: for문으로 호선 하나씩 필터링 → 정렬 → tail(1) → 모으기)

rows = []
for line in valid_lines:
    tmp = df[df['호선명'] == line].sort_values('총승하차인원').tail(1)
    rows.append(tmp[['호선명','지하철역','총승하차인원']])

top_by_line = pd.concat(rows, ignore_index=True)

print('=' * 100)
print("문제 21")
print('=' * 100)

print(top_by_line)



# 문제 22 🔥 (피크시간대) 07-08/08-09/09-10 중에서 "유동(승차+하차)"이 가장 큰 시간대를
# '피크시간대' 컬럼으로 만들고, 그 최대 유동값을 '피크유동값' 컬럼으로 만드시오.

df['07-08_유동'] = df['07시-08시 승차인원'] + df['07시-08시 하차인원']
df['08-09_유동'] = df['08시-09시 승차인원'] + df['08시-09시 하차인원']
df['09-10_유동'] = df['09시-10시 승차인원'] + df['09시-10시 하차인원']

peak_cols = ['07-08_유동', '08-09_유동', '09-10_유동']
df['피크유동값'] = df[peak_cols].max(axis=1)

df['피크시간대'] = np.select(
    [
        df['07-08_유동'] == df['피크유동값'],
        df['08-09_유동'] == df['피크유동값'],
        df['09-10_유동'] == df['피크유동값'],
    ],
    ['07-08', '08-09', '09-10'],
    default='동률'
)

print('=' * 100)
print("문제 22")
print('=' * 100)

print(df[['호선명','지하철역','피크시간대','피크유동값']].head(10))



# 문제 23 🔥 (4분류) 역성격을 아래 규칙으로 4개로 더 세분화하시오.
# - '강주거': 출근승차 >= 출근하차 * 1.5
# - '강업무': 출근하차 >= 출근승차 * 1.5
# - '균형형': abs(출근승차-출근하차) <= (출근승차+출근하차)*0.1
# - 그 외: '일반'

total_commute = df['출근승차'] + df['출근하차']
diff_commute = (df['출근승차'] - df['출근하차']).abs()

df['역성격_4분류'] = '일반'
df.loc[df['출근승차'] >= df['출근하차'] * 1.5, '역성격_4분류'] = '강주거'
df.loc[df['출근하차'] >= df['출근승차'] * 1.5, '역성격_4분류'] = '강업무'
df.loc[diff_commute <= total_commute * 0.1, '역성격_4분류'] = '균형형'

print('=' * 100)
print("문제 23")
print('=' * 100)

print(df[['호선명','지하철역','출근승차','출근하차','역성격_4분류']].head(10))

